name: Deploy to HuggingFace Spaces

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install huggingface_hub
        run: pip install huggingface_hub

      - name: Deploy to HuggingFace Spaces
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python << 'SCRIPT'
          from huggingface_hub import HfApi
          import os
          import sys

          token = os.environ.get('HF_TOKEN')
          if not token:
              print("ERROR: HF_TOKEN secret is not set!")
              print("Please add HF_TOKEN to your repository secrets:")
              print("  1. Go to Settings > Secrets and variables > Actions")
              print("  2. Click 'New repository secret'")
              print("  3. Name: HF_TOKEN, Value: your HuggingFace token")
              sys.exit(1)

          print("HF_TOKEN found, starting deployment...")
          api = HfApi(token=token)

          # Upload files to the Space
          api.upload_folder(
              folder_path='.',
              repo_id='eduardofarina/MedGemma1.5ReportGenerator',
              repo_type='space',
              ignore_patterns=[
                  'models/*',
                  '.git/*',
                  '.github/*',
                  '__pycache__/*',
                  '*.pyc',
                  '.env',
                  'environment.yml',
                  'setup*.bat',
                  'setup*.sh',
                  'check_gpu.py',
                  'download_model.py',
                  'dicom_utils.py',
              ],
          )
          print('Deployment to HuggingFace Spaces complete!')
          SCRIPT
